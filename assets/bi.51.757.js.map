{"version":3,"file":"bi.51.757.js","sources":["../frontend-dev/src/components/AllIntegrations/Mautic/MauticCommonFunc.js"],"sourcesContent":["import bitsFetch from \"../../../Utils/bitsFetch\";\nimport { deepCopy } from \"../../../Utils/Helpers\";\nimport { sprintf, __ } from \"../../../Utils/i18nwrap\";\n\nexport const handleInput = (\n  e,\n  sheetConf,\n  setSheetConf,\n  formID,\n  setIsLoading,\n  setSnackbar,\n  isNew,\n  error,\n  setError\n) => {\n  let newConf = { ...sheetConf };\n  if (isNew) {\n    const rmError = { ...error };\n    rmError[e.target.name] = \"\";\n    setError({ ...rmError });\n  }\n  newConf[e.target.name] = e.target.value;\n  switch (e.target.name) {\n    case \"listId\":\n      newConf = listChange(\n        newConf,\n        formID,\n        setSheetConf,\n        setIsLoading,\n        setSnackbar\n      );\n      break;\n    default:\n      break;\n  }\n  setSheetConf({ ...newConf });\n};\n\nexport const getAllFields = (\n  mauticConf,\n  setMauticConf,\n  setIsLoading,\n  setSnackbar\n) => {\n  setIsLoading(true);\n  const requestParams = {\n    clientId: mauticConf.clientId,\n    clientSecret: mauticConf.clientSecret,\n    baseUrl: mauticConf.baseUrl,\n    tokenDetails: mauticConf.tokenDetails,\n  };\n  bitsFetch(requestParams, \"mautic_get_fields\")\n    .then((result) => {\n      if (result && result.success) {\n        const newConf = { ...mauticConf };\n        if (result.data) {\n          if (!newConf.default) {\n            newConf.default = {};\n          }\n          if (!newConf.default?.fields) {\n            newConf.default.fields = {};\n          }\n          newConf.default.fields = result.data;\n          newConf.field_map = generateMappedField(result.data);\n        }\n\n        if (result.data?.tokenDetails) {\n          newConf.tokenDetails = result.data.tokenDetails;\n        }\n        setSnackbar({\n          show: true,\n          msg: __(\"Fields refreshed\", \"bit-integrations\"),\n        });\n        setMauticConf({ ...newConf });\n      } else {\n        setSnackbar({\n          show: true,\n          msg: __(\n            \"Fields refresh failed. please try again\",\n            \"bit-integrations\"\n          ),\n        });\n      }\n      setIsLoading(false);\n    })\n    .catch(() => setIsLoading(false));\n};\nexport const getAllTags = (\n  mauticConf,\n  setMauticConf,\n  setIsLoading,\n  setSnackbar\n) => {\n  setIsLoading(true);\n  const requestParams = {\n    clientId: mauticConf.clientId,\n    clientSecret: mauticConf.clientSecret,\n    baseUrl: mauticConf.baseUrl,\n    tokenDetails: mauticConf.tokenDetails,\n  };\n  bitsFetch(requestParams, \"mautic_get_tags\")\n    .then((result) => {\n      if (result && result.success) {\n        const newConf = { ...mauticConf };\n        if (result.data) {\n          if (!newConf.default) {\n            newConf.default = {};\n          }\n          if (!newConf.default?.tags) {\n            newConf.default.tags = {};\n          }\n          newConf.default.tags = result.data;\n        }\n\n        if (result.data?.tokenDetails) {\n          newConf.tokenDetails = result.data.tokenDetails;\n        }\n        setSnackbar({\n          show: true,\n          msg: __(\"Tags refreshed\", \"bit-integrations\"),\n        });\n        setMauticConf({ ...newConf });\n      } else {\n        setSnackbar({\n          show: true,\n          msg: __(\"Tags refresh failed. please try again\", \"bit-integrations\"),\n        });\n      }\n      setIsLoading(false);\n    })\n    .catch(() => setIsLoading(false));\n};\n\nexport const setGrantTokenResponse = (integ) => {\n  const grantTokenResponse = {};\n  const authWindowLocation = window.location.href;\n  const queryParams = authWindowLocation\n    .replace(`${window.opener.location.href}`, \"\")\n    .split(\"&\");\n  if (queryParams) {\n    queryParams.forEach((element) => {\n      const gtKeyValue = element.split(\"=\");\n      if (gtKeyValue[1]) {\n        // eslint-disable-next-line prefer-destructuring\n        grantTokenResponse[gtKeyValue[0]] = gtKeyValue[1];\n      }\n    });\n  }\n  localStorage.setItem(`__${integ}`, JSON.stringify(grantTokenResponse));\n  window.close();\n};\n\nexport const handleMauticAuthorize = (\n  integ,\n  confTmp,\n  setConf,\n  setError,\n  setisAuthorized,\n  setIsLoading,\n  setSnackbar\n) => {\n  if (!confTmp.clientId || !confTmp.clientSecret || !confTmp.baseUrl) {\n    setError({\n      clientId: !confTmp.clientId\n        ? __(\"Client ID cann't be empty\", \"bit-integrations\")\n        : \"\",\n      clientSecret: !confTmp.clientSecret\n        ? __(\"Secret key cann't be empty\", \"bit-integrations\")\n        : \"\",\n      baseUrl: !confTmp.baseUrl\n        ? __(\"Base Url can't be empty\", \"bit-integrations\")\n        : \"\",\n    });\n    return;\n  }\n  setIsLoading(true);\n\n  const apiEndpoint = `${confTmp.baseUrl}/oauth/v2/authorize?client_id=${\n    confTmp.clientId\n  }&redirect_uri=${encodeURIComponent(\n    window.location.href\n  )}&response_type=code`;\n  const authWindow = window.open(\n    apiEndpoint,\n    integ,\n    \"width=400,height=609,toolbar=off\"\n  );\n  const popupURLCheckTimer = setInterval(() => {\n    if (authWindow.closed) {\n      clearInterval(popupURLCheckTimer);\n      let grantTokenResponse = {};\n      let isauthRedirectLocation = false;\n      const bitsMautic = localStorage.getItem(`__${integ}`);\n      if (bitsMautic) {\n        isauthRedirectLocation = true;\n        grantTokenResponse = JSON.parse(bitsMautic);\n        localStorage.removeItem(`__${integ}`);\n        if (grantTokenResponse.code.search(\"#\")) {\n          const [code] = grantTokenResponse.code.split(\"#\");\n          grantTokenResponse.code = code;\n        }\n      }\n      if (\n        !grantTokenResponse.code ||\n        grantTokenResponse.error ||\n        !grantTokenResponse ||\n        !isauthRedirectLocation\n      ) {\n        const errorCause = grantTokenResponse.error\n          ? `Cause: ${grantTokenResponse.error}`\n          : \"\";\n        setSnackbar({\n          show: true,\n          msg: `${__(\n            \"Authorization failed\",\n            \"bit-integrations\"\n          )} ${errorCause}. ${__(\"please try again\", \"bit-integrations\")}`,\n        });\n        setIsLoading(false);\n      } else {\n        const newConf = { ...confTmp };\n        newConf.accountServer = grantTokenResponse[\"accounts-server\"];\n        tokenHelper(\n          grantTokenResponse,\n          newConf,\n          setConf,\n          setisAuthorized,\n          setIsLoading,\n          setSnackbar\n        );\n      }\n    }\n  }, 500);\n};\n\nconst tokenHelper = (\n  grantToken,\n  confTmp,\n  setConf,\n  setisAuthorized,\n  setIsLoading,\n  setSnackbar\n) => {\n  const tokenRequestParams = { ...grantToken };\n  tokenRequestParams.clientId = confTmp.clientId;\n  tokenRequestParams.clientSecret = confTmp.clientSecret;\n  tokenRequestParams.baseUrl = confTmp.baseUrl;\n  tokenRequestParams.redirectURI = window.location.href;\n\n  bitsFetch(tokenRequestParams, \"mautic_generate_token\")\n    .then((result) => result)\n    .then((result) => {\n      if (result && result.success) {\n        const newConf = { ...confTmp };\n        newConf.tokenDetails = result.data;\n        setConf(newConf);\n        setisAuthorized(true);\n        setSnackbar({\n          show: true,\n          msg: __(\"Authorized Successfully\", \"bit-integrations\"),\n        });\n      } else if (\n        (result && result.data && result.data.data) ||\n        (!result.success && typeof result.data === \"string\")\n      ) {\n        setSnackbar({\n          show: true,\n          msg: `${__(\"Authorization failed Cause:\", \"bit-integrations\")}${\n            result.data.data || result.data\n          }. ${__(\"please try again\", \"bit-integrations\")}`,\n        });\n      } else {\n        setSnackbar({\n          show: true,\n          msg: __(\"Authorization failed. please try again\", \"bit-integrations\"),\n        });\n      }\n      setIsLoading(false);\n    });\n};\n\nexport const checkMappedFields = (mauticConf) => {\n  const mappedFleld = mauticConf.field_map\n    ? mauticConf.field_map.filter(\n        (mapped) => !mapped.formField && !mapped.mauticField\n      )\n    : [];\n  if (mappedFleld.length > 0) {\n    return false;\n  }\n  return true;\n};\n\nexport const generateMappedField = (mauticFields) => {\n  const requiredFlds = mauticFields.filter((fld) => fld.required === true);\n  return requiredFlds.length > 0\n    ? requiredFlds.map((field) => ({\n        formField: \"\",\n        mauticField: field.fieldAlias,\n      }))\n    : [{ formField: \"\", mauticField: \"\" }];\n};\n"],"names":["__","bitsFetch","handleInput","e","sheetConf","setSheetConf","formID","setIsLoading","setSnackbar","isNew","error","setError","newConf","__spreadValues","rmError","getAllFields","mauticConf","setMauticConf","requestParams","result","_a","_b","generateMappedField","getAllTags","setGrantTokenResponse","integ","grantTokenResponse","queryParams","element","gtKeyValue","handleMauticAuthorize","confTmp","setConf","setisAuthorized","apiEndpoint","authWindow","popupURLCheckTimer","isauthRedirectLocation","bitsMautic","code","errorCause","tokenHelper","grantToken","tokenRequestParams","checkMappedFields","mapped","mauticFields","requiredFlds","fld","field"],"mappings":"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"}